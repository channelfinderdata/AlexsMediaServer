<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex's Media Server</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to set the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling when modal/blocked overlay is active */
        }
        /* Custom scrollbar for a cleaner look, matching the new palette */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d; /* Darker track */
        }
        ::-webkit-scrollbar-thumb {
            background: #fbbfbf24; /* Amber thumb (amber-400) */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #fcd34d; /* Lighter amber on hover (amber-300) */
        }
        /* Custom class for the transparent haze effect around round images */
        .haze-effect {
            /* Softer, more diffused shadow for blending */
            box-shadow: 0 0 15px 5px rgba(251, 191, 36, 0.3); /* Amber-400 with 30% opacity, larger blur, smaller spread */
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* Smooth transition for hover effects */
            will-change: transform; /* Optimize for animation performance */
        }

        /* Flutter effect on hover */
        .haze-effect:hover {
            transform: translateY(-5px); /* Moves slightly up */
            box-shadow: 0 0 25px 8px rgba(251, 191, 36, 0.5); /* Haze becomes more prominent on hover */
        }

        /* Container for the 3D rotation effect */
        .logo-3d-container {
            position: relative;
            /* Add perspective to the parent for 3D effect */
            perspective: 1000px;
            /* Ensure children are transformed in 3D space */
            transform-style: preserve-3d;
        }

        /* Image within the 3D container */
        .logo-3d-container img {
            transition: transform 0.1s linear; /* Smoother, quicker transition for rotation */
            transform-style: preserve-3d; /* Keep the image itself in 3D space */
            /* Set transform origin to the center for natural rotation */
            transform-origin: center center;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Darker overlay to truly hide content */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1005; /* Modal overlay is above main content but below header */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 400px;
            text-align: center;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            z-index: 1010; /* Modal content is above the overlay */
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        /* Hide the close button for the initial gatekeeping modal */
        .modal-close-btn {
            display: none; /* Hide close button for mandatory entry */
        }

        /* Style to hide main content and modal initially */
        .hidden-element {
            display: none;
        }

        /* Ensure header is positioned for z-index to work */
        header {
            position: relative;
            z-index: 1000; /* Header is above blocked overlay and modal overlay */
        }

        /* New style for the full-screen IP blocked message */
        .blocked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Even darker overlay */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1005; /* Same as modal overlay, ensuring it covers main content */
            color: #ef4444; /* red-500 */
            font-size: 2.5rem;
            text-align: center;
            padding: 2rem;
            line-height: 1.5;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .blocked-overlay.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Blocked IP Overlay - Initially Hidden -->
    <div id="blockedIpOverlay" class="blocked-overlay hidden-element">
        <h2 class="text-5xl font-bold mb-4">Access Denied!</h2>
        <p>Your IP address has been blocked from entering this site due to repeated failed attempts.</p>
        <p class="text-sm mt-4 text-gray-400">Please contact the administrator if you believe this is an error.</p>
    </div>

    <!-- Header Section -->
    <header class="bg-gray-800 p-8 shadow-lg rounded-b-xl mx-4 mt-4 flex justify-center items-center relative">
        <h1 class="text-5xl font-bold text-amber-400">Alex's Media Server</h1>
        <!-- Version Number -->
        <div class="absolute top-4 right-4 text-gray-400 text-sm">
            v1.0.3
        </div>
    </header>

    <!-- Main Content Wrapper - Initially Hidden -->
    <div id="mainContentWrapper" class="flex-grow flex flex-col hidden-element">
        <main class="flex-grow container mx-auto p-4 md:p-8 space-y-12">
            <!-- Overseerr Section -->
            <section id="overseerr" class="bg-gray-800 p-6 md:p-10 rounded-xl shadow-xl border border-amber-700 hover:border-amber-500 transition-all duration-300 flex flex-col md:flex-row items-center justify-center md:justify-between space-y-6 md:space-y-0 md:space-x-10 overflow-hidden">
                <div class="flex-shrink-0 logo-3d-container">
                    <img src="https://getumbrel.github.io/umbrel-apps-gallery/overseerr/icon.svg" alt="Overseerr Logo" class="w-24 h-24 md:w-32 md:h-32 object-contain rounded-full haze-effect" data-rotation-strength="25">
                </div>
                <div class="flex-grow text-center md:text-left">
                    <h2 class="text-4xl font-semibold text-amber-400 mb-4">Overseerr</h2>
                    <p class="text-gray-300 leading-relaxed mb-6 max-w-2xl mx-auto md:mx-0">
                        Can't find that movie or show on the server? Submit your requests here! We'll do our best to get it added for everyone to enjoy.
                    </p>
                    <!-- Changed from <a> with href to <button> for JS handling -->
                    <button class="service-link inline-block bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-75" data-service="1">
                        Request Something!
                    </button>
                </div>
            </section>

            <!-- Plex Section -->
            <section id="plex" class="bg-gray-800 p-6 md:p-10 rounded-xl shadow-xl border border-amber-700 hover:border-amber-500 transition-all duration-300 flex flex-col md:flex-row-reverse items-center justify-center md:justify-between space-y-6 md:space-y-0 md:space-x-reverse md:space-x-10 overflow-hidden">
                <div class="flex-shrink-0 logo-3d-container">
                    <img src="https://i.redd.it/5x93lknmuaw81.jpg" alt="Plex Logo" class="w-24 h-24 md:w-32 md:h-32 object-contain rounded-full haze-effect" data-rotation-strength="25">
                </div>
                <div class="flex-grow text-center md:text-right">
                    <h2 class="text-4xl font-semibold text-amber-400 mb-4">Plex Media Server</h2>
                    <p class="text-gray-300 leading-relaxed mb-6 max-w-2xl mx-auto md:mx-0">
                        Dive into our vast collection of movies, TV shows, and more! Everything you love, organized and ready to stream instantly.
                    </p>
                    <!-- Changed from <a> with href to <button> for JS handling -->
                    <button class="service-link inline-block bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-75" data-service="2">
                        Watch Now!
                    </button>
                </div>
            </section>

            <!-- Audiobookshelf Section -->
            <section id="audiobookshelf" class="bg-gray-800 p-6 md:p-10 rounded-xl shadow-xl border border-amber-700 hover:border-amber-500 transition-all duration-300 flex flex-col md:flex-row items-center justify-center md:justify-between space-y-6 md:space-y-0 md:space-x-10 overflow-hidden">
                <div class="flex-shrink-0 logo-3d-container">
                    <img src="https://is1-ssl.mzstatic.com/image/thumb/Purple221/v4/68/a8/14/68a814c2-2f2c-db51-deb1-545b818e67a9/Icons-1x_U007emarketing-0-8-0-85-220-0.png/1920x1080bb-80.png" alt="Audiobookshelf Logo" class="w-24 h-24 md:w-32 md:h-32 object-contain rounded-full haze-effect" data-rotation-strength="25">
                </div>
                <div class="flex-grow text-center md:text-left">
                    <h2 class="text-4xl font-semibold text-amber-400 mb-4">Audiobookshelf</h2>
                    <p class="text-gray-300 leading-relaxed mb-6 max-w-2xl mx-auto md:mx-0">
                        Prefer listening? Explore our growing library of audiobooks and podcasts, all ready for you to enjoy on the go.
                    </p>
                    <!-- Changed from <a> with href to <button> for JS handling -->
                    <button class="service-link inline-block bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-75" data-service="3">
                        Listen Up!
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Master Code Modal - Initially Hidden -->
    <div id="masterCodeModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-amber-400 mb-4">Access Alex's Media Server</h3>
            <p class="text-gray-300 mb-4">
                Please enter the master code to access the server.
            </p>
            <input type="password" id="masterCodeInput" placeholder="Enter code here"
                   class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:border-amber-500">
            <button id="submitMasterCode"
                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-75">
                Unlock Server
            </button>
            <p id="masterCodeMessage" class="text-gray-300 mt-4"></p>
        </div>
    </div>

    <script type="module">
        // Element references
        const blockedIpOverlay = document.getElementById('blockedIpOverlay');
        const masterCodeModal = document.getElementById('masterCodeModal');
        const masterCodeInput = document.getElementById('masterCodeInput');
        const submitMasterCodeBtn = document.getElementById('submitMasterCode');
        const masterCodeMessage = document.getElementById('masterCodeMessage');
        const mainContentWrapper = document.getElementById('mainContentWrapper');
        const serviceLinks = document.querySelectorAll('.service-link');

        // IMPORTANT: This is the URL of your deployed Cloudflare Worker.
        const WORKER_BASE_URL = "https://verify-master-code-worker.authme.workers.dev"; // Confirm this URL is correct

        let storedMasterCode = '';
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // Function to initialize 3D logo effects (called only after successful login)
        function initialize3DEffects() {
            const sections = document.querySelectorAll('section');

            sections.forEach(section => {
                const logoContainer = section.querySelector('.logo-3d-container');
                const img = logoContainer ? logoContainer.querySelector('img') : null;

                if (img) {
                    const rotationStrength = parseFloat(img.dataset.rotationStrength) || 10;

                    logoContainer.addEventListener('mousemove', (e) => {
                        const rect = logoContainer.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        const mouseX = e.clientX;
                        const mouseY = e.clientY;

                        const offsetX = (mouseX - centerX) / (rect.width / 2);
                        const offsetY = (mouseY - centerY) / (rect.height / 2);

                        const rotateY = offsetX * rotationStrength;
                        const rotateX = -offsetY * rotationStrength;

                        img.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                    });

                    logoContainer.addEventListener('mouseleave', () => {
                        img.style.transform = `rotateX(0deg) rotateY(0deg)`;
                    });
                }
            });
        }

        // --- NEW: Function to check IP status on page load ---
        async function checkIpStatus() {
            try {
                const response = await fetch(`${WORKER_BASE_URL}/checkIpStatus`, {
                    method: 'POST', // Use POST as defined in Worker
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // No body needed for this specific check, as IP is from CF-Connecting-IP
                    body: JSON.stringify({}) // Send an empty JSON object for valid POST request
                });

                const data = await response.json();

                if (response.ok && data.status === 'blocked') {
                    // Show the blocked IP overlay
                    blockedIpOverlay.classList.remove('hidden-element');
                    blockedIpOverlay.classList.add('show');
                    // Hide any other elements that might appear by default (like the modal)
                    masterCodeModal.classList.add('hidden-element');
                    masterCodeModal.classList.remove('show');
                    mainContentWrapper.classList.add('hidden-element'); // Ensure main content is hidden
                    document.body.style.overflow = 'hidden'; // Keep body fixed
                } else {
                    // IP is allowed, show the master code modal
                    masterCodeModal.classList.remove('hidden-element');
                    masterCodeModal.classList.add('show');
                    document.body.style.overflow = 'hidden'; // Keep body fixed
                }
            } catch (error) {
                console.error("Error checking IP status:", error);
                // If there's an error checking IP status, default to showing the login modal
                masterCodeMessage.textContent = "Error communicating with server. Please try again later.";
                masterCodeMessage.style.color = '#ef4444';
                masterCodeModal.classList.remove('hidden-element');
                masterCodeModal.classList.add('show');
                document.body.style.overflow = 'hidden'; // Keep body fixed
            }
        }

        // --- Event Listener for initial Master Code submission ---
        submitMasterCodeBtn.addEventListener('click', async () => {
            const userEnteredCode = masterCodeInput.value;

            if (!WORKER_BASE_URL) {
                masterCodeMessage.textContent = "Error: Worker URL not configured.";
                masterCodeMessage.style.color = '#ef4444';
                return;
            }

            try {
                const response = await fetch(`${WORKER_BASE_URL}/verifyMasterCode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: userEnteredCode }),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    masterCodeMessage.textContent = "Success! Welcome to Alex's Media Server!";
                    masterCodeMessage.style.color = '#10b981';
                    masterCodeInput.style.borderColor = '#10b981';

                    storedMasterCode = userEnteredCode;

                    setTimeout(() => {
                        masterCodeModal.classList.remove('show');
                        masterCodeModal.classList.add('hidden-element'); // Ensure it's fully hidden
                        mainContentWrapper.classList.remove('hidden-element'); // Show main content
                        document.body.style.overflow = 'auto'; // Allow scrolling on main content
                        initialize3DEffects();
                    }, 700);

                } else {
                    throw new Error(data.message || "Authentication failed.");
                }

            } catch (error) {
                retryCount++;
                console.error("Authentication error:", error);

                if (retryCount >= MAX_RETRIES) {
                    masterCodeMessage.textContent = "Too many incorrect attempts. Your IP has been blocked.";
                    masterCodeMessage.style.color = '#dc2626';
                    masterCodeInput.disabled = true;
                    submitMasterCodeBtn.disabled = true;
                    masterCodeInput.style.borderColor = '#dc2626';
                    submitMasterCodeBtn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                    submitMasterCodeBtn.classList.add('bg-gray-500', 'cursor-not-allowed');

                    // If IP is blocked by worker, immediately transition to blocked overlay
                    if (error.message.includes('Your IP has been blocked')) {
                        setTimeout(() => {
                            masterCodeModal.classList.remove('show');
                            masterCodeModal.classList.add('hidden-element');
                            blockedIpOverlay.classList.remove('hidden-element');
                            blockedIpOverlay.classList.add('show');
                            document.body.style.overflow = 'hidden'; // Ensure body remains fixed
                        }, 700);
                    }

                } else {
                    masterCodeMessage.textContent = `Incorrect code. ${MAX_RETRIES - retryCount} attempts remaining.`;
                    masterCodeMessage.style.color = '#ef4444';
                    masterCodeInput.style.borderColor = '#ef4444';
                }
            }
        });

        // --- Event Listener for Service Links ---
        serviceLinks.forEach(button => {
            button.addEventListener('click', async (event) => {
                event.preventDefault();

                if (!storedMasterCode) {
                    alert('Please unlock the server first by entering the master code!');
                    return;
                }

                const serviceId = event.currentTarget.dataset.service;

                try {
                    const response = await fetch(`${WORKER_BASE_URL}/redirect-service`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            password: storedMasterCode,
                            serviceId: serviceId
                        }),
                    });

                    const data = await response.json();

                    if (response.ok && data.success && data.redirectUrl) {
                        window.open(data.redirectUrl, '_blank');
                        console.log(`Successfully opened service (ID: ${serviceId}) in new tab.`);
                    } else {
                        alert(`Failed to access service (ID: ${serviceId}): ${data.message || 'Unknown error'}`);
                        console.error(`Failed to access service (ID: ${serviceId}):`, data);
                    }
                } catch (error) {
                    alert(`An error occurred while trying to access service (ID: ${serviceId}). Please try again.`);
                    console.error(`Error accessing service (ID: ${serviceId}):`, error);
                }
            });
        });

        // --- Initial IP Status Check on page load ---
        document.addEventListener('DOMContentLoaded', checkIpStatus);
    </script>
</body>
</html>
